<!--pages/product/detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else>
    <!-- è¿”å›æŒ‰é’® -->
    <view class="back-button" bindtap="onGoBack">
      <text class="back-icon">â†</text>
      <text class="back-text">è¿”å›</text>
    </view>
    
    <!-- å•†å“å›¾ç‰‡è½®æ’­ -->
    <swiper class="product-swiper" indicator-dots="{{true}}" autoplay="{{true}}">
      <swiper-item wx:for="{{product.images || [product.image]}}" wx:key="*this">
        <image class="product-image" src="{{item}}" mode="aspectFit" />
      </swiper-item>
    </swiper>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="product-info card">
      <view class="price-section">
        <text class="current-price">Â¥{{selectedSku ? selectedSku.price : product.price}}</text>
        <text class="original-price" wx:if="{{product.originalPrice}}">
          Â¥{{product.originalPrice}}
        </text>
      </view>

      <text class="product-name">{{product.name}}</text>
      
      <!-- å•†å“ç®€ä»‹ -->
      <view class="product-description" wx:if="{{product.description}}">
        <text class="description-text">{{product.description}}</text>
      </view>
      
      <view class="meta-info">
        <text>é”€é‡: {{product.sales || 0}}</text>
        <text>åº“å­˜: {{selectedSku ? selectedSku.stock : product.stock}}</text>
      </view>
    </view>

    <!-- SKUé€‰æ‹© -->
    <view class="sku-section card" bindtap="onOpenSkuPicker">
      <text class="section-title">é€‰æ‹©è§„æ ¼</text>
      <view class="sku-selected">
        <text wx:if="{{selectedSku}}">{{selectedSku.name}}</text>
        <text wx:else class="placeholder">è¯·é€‰æ‹©è§„æ ¼</text>
      </view>
      <text class="arrow">â€º</text>
    </view>

    <!-- å•†å“è¯¦æƒ… -->
    <view class="detail-section card">
      <text class="section-title">å•†å“è¯¦æƒ…</text>
      <rich-text class="product-detail" nodes="{{product.detail}}" />
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="action-bar">
      <view class="action-left">
        <view class="action-item" bindtap="onGoToCart">
          <text class="icon">ğŸ›’</text>
          <text class="badge" wx:if="{{cartCount > 0}}">{{cartCount}}</text>
          <text>è´­ç‰©è½¦</text>
        </view>
        <view class="action-item" bindtap="onToggleFavorite">
          <text class="icon {{isFavorite ? 'active' : ''}}">â¤ï¸</text>
          <text>æ”¶è—</text>
        </view>
      </view>
      
      <view class="action-right">
        <button class="btn-add-cart" bindtap="onAddToCart">åŠ å…¥è´­ç‰©è½¦</button>
        <button class="btn-buy-now" bindtap="onBuyNow">ç«‹å³è´­ä¹°</button>
      </view>
    </view>
  </view>

  <!-- SKUé€‰æ‹©å¼¹çª— -->
  <view class="sku-modal {{showSkuPicker ? 'show' : ''}}">
    <view class="modal-content">
      <view class="modal-header">
        <image class="product-thumb" src="{{product.image}}" />
        <view class="product-info">
          <text class="price">Â¥{{selectedSku ? selectedSku.price : product.price}}</text>
          <text class="stock">åº“å­˜: {{selectedSku ? selectedSku.stock : product.stock}}</text>
          <text class="selected-sku" wx:if="{{selectedSku}}">å·²é€‰: {{selectedSku.name}}</text>
        </view>
        <text class="close-btn" bindtap="onCloseSkuPicker">Ã—</text>
      </view>

      <view class="sku-options">
        <text class="option-title">è§„æ ¼</text>
        <view class="option-list">
          <view 
            class="option-item {{selectedSku && selectedSku.id === sku.id ? 'active' : ''}}"
            wx:for="{{product.skus}}"
            wx:key="id"
            data-sku="{{sku}}"
            bindtap="onSelectSku"
          >
            <text>{{sku.name}}</text>
          </view>
        </view>
      </view>

      <view class="quantity-section">
        <text class="quantity-title">æ•°é‡</text>
        <view class="quantity-control">
          <text class="btn-decrease" bindtap="onDecrease">-</text>
          <input 
            class="quantity-input" 
            type="number" 
            value="{{quantity}}"
            bindinput="onQuantityChange"
          />
          <text class="btn-increase" bindtap="onIncrease">+</text>
        </view>
      </view>

      <button class="btn-confirm" bindtap="onAddToCart">ç¡®å®š</button>
    </view>
  </view>

  <!-- é®ç½©å±‚ -->
  <view 
    class="mask {{showSkuPicker ? 'show' : ''}}" 
    bindtap="onCloseSkuPicker"
  ></view>
</view>